<div>
  <div class="header-actions" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2>Gerenciamento de Reuniões</h2>
    <button *ngIf="grupoSelecionado" class="btn btn-primary" (click)="openModal()">Nova Reunião</button>
  </div>

  <!-- Seleção inicial de grupo -->
  <div *ngIf="!grupoSelecionado" class="info-box" style="background-color: #f8f9fa; padding: 20px; border-radius: 4px; margin-bottom: 20px; text-align: center;">
    <h3 style="margin-bottom: 15px;">Selecione um Grupo</h3>
    <div class="form-group" style="max-width: 400px; margin: 0 auto;">
      <label style="font-size: 1.1rem; margin-bottom: 10px; display: block;">Grupo *</label>
      <select [(ngModel)]="filtroGrupo" (change)="selecionarGrupo()" style="width: 100%; padding: 15px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;">
        <option [value]="null">Selecione o grupo</option>
        <option *ngFor="let grupo of grupos" [value]="grupo.Id">{{ grupo.Nome }}</option>
      </select>
    </div>
  </div>

  <!-- Filtros de mês e ano (só aparecem após selecionar grupo) -->
  <div *ngIf="grupoSelecionado">
    <div class="info-box" style="background-color: #e8f5e9; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
      <p style="margin: 0; color: #666;">
        <strong>Grupo selecionado:</strong> {{ getGrupoNomeSelecionado() }} | Selecione Mês e Ano para visualizar as reuniões.
      </p>
    </div>

    <div class="filtros-container" style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
      <div class="form-group" style="max-width: 150px; flex: 1; min-width: 120px;">
        <label>Ano *</label>
        <select [(ngModel)]="filtroAno" (change)="onFiltroChange()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
          <option [value]="null">Selecione o ano</option>
          <option *ngFor="let ano of getAnos()" [value]="ano">{{ ano }}</option>
        </select>
      </div>

      <div class="form-group" style="max-width: 200px; flex: 1; min-width: 150px;">
        <label>Mês *</label>
        <select [(ngModel)]="filtroMes" (change)="onFiltroChange()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
          <option [value]="null">Selecione o mês</option>
          <option *ngFor="let mes of getMeses()" [value]="mes.valor">{{ mes.nome }}</option>
        </select>
      </div>
    </div>
  </div>

  <div class="table-container" *ngIf="filtrosPreenchidos">
  <table>
    <thead>
      <tr>
        <th class="col-id">ID</th>
        <th class="col-grupo">Grupo</th>
        <th class="col-data">Data</th>
        <th class="col-membros">Membros</th>
        <th class="col-visitantes">Visitantes</th>
        <th class="col-total-setima">Total Sétima</th>
        <th class="col-total-despesas">Total Despesas</th>
        <th class="col-acoes">Ações</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let reuniao of reunioes">
        <td class="col-id">{{ reuniao.Id }}</td>
        <td class="col-grupo">{{ reuniao.NomeGrupo || getGrupoNome(reuniao.IdGrupo) }}</td>
        <td class="col-data">{{ formatDate(reuniao.Data) }}</td>
        <td class="col-membros">{{ reuniao.Membros }}</td>
        <td class="col-visitantes">{{ reuniao.Visitantes }}</td>
        <td class="col-total-setima">R$ {{ formatCurrency(getTotalSetima(reuniao)) }}</td>
        <td class="col-total-despesas">R$ {{ formatCurrency(getTotalDespesas(reuniao.Id)) }}</td>
        <td class="col-acoes">
          <button class="btn btn-success" (click)="openModal(reuniao)">Editar</button>
          <button class="btn btn-danger" (click)="deleteReuniao(reuniao.Id)">Excluir</button>
        </td>
      </tr>
      <tr *ngIf="reunioes.length === 0">
        <td class="col-data" colspan="2" style="text-align: center; padding: 20px;">
          Nenhuma reunião cadastrada
        </td>
      </tr>
    </tbody>
  </table>
  </div>

  <div class="modal" [class.show]="showModal">
    <div class="modal-content">
      <span class="close" (click)="closeModal()">&times;</span>
      <h2>{{ isEdit ? 'Editar Reunião' : 'Nova Reunião' }}</h2>
      
      <div class="form-container">
        <div class="form-row">
          <div class="form-group">
            <label>Grupo *</label>
            <select [(ngModel)]="reuniao.IdGrupo" required [disabled]="!isEdit">
              <option [value]="null">Selecione um grupo</option>
              <option *ngFor="let grupo of grupos" [value]="grupo.Id">{{ grupo.Nome }}</option>
            </select>
            <small *ngIf="!isEdit" style="display: block; margin-top: 5px; color: #666;">
              O grupo já foi selecionado na tela principal
            </small>
          </div>

          <div class="form-group">
            <label>Data *</label>
            <input type="date" [(ngModel)]="reuniao.Data" required>
          </div>
        </div>

        <div class="form-row form-row-duas-colunas">
          <div class="form-group">
            <label>Membros</label>
            <input type="number" [(ngModel)]="reuniao.Membros" min="0">
          </div>

          <div class="form-group">
            <label>Visitantes</label>
            <input type="number" [(ngModel)]="reuniao.Visitantes" min="0">
          </div>
        </div>

        <div class="form-row form-row-duas-colunas">
          <div class="form-group">
            <label>Valor Sétima</label>
            <input type="number" step="0.01" [(ngModel)]="reuniao.ValorSetima" min="0">
          </div>

          <div class="form-group">
            <label>Valor Sétima PIX</label>
            <input type="number" step="0.01" [(ngModel)]="reuniao.ValorSetimaPix" min="0">
          </div>
        </div>

        <div class="form-group">
          <label>Fatos Relevantes</label>
          <textarea [(ngModel)]="reuniao.FatosRelevantes" rows="4"></textarea>
        </div>

        <h3 class="section-title" style="margin-top: 20px; margin-bottom: 15px;">Novos Membros</h3>
        <div class="form-row form-row-duas-colunas">
          <div class="form-group">
            <label>Ingresso</label>
            <input type="number" [(ngModel)]="reuniao.Ingresso" min="0">
          </div>

          <div class="form-group">
            <label>30 Dias</label>
            <input type="number" [(ngModel)]="reuniao.TrintaDias" min="0">
          </div>

          <div class="form-group">
            <label>60 Dias</label>
            <input type="number" [(ngModel)]="reuniao.SessentaDias" min="0">
          </div>

          <div class="form-group">
            <label>90 Dias</label>
            <input type="number" [(ngModel)]="reuniao.NoventaDias" min="0">
          </div>

          <div class="form-group">
            <label>6 Meses</label>
            <input type="number" [(ngModel)]="reuniao.SeisMeses" min="0">
          </div>

          <div class="form-group">
            <label>9 Meses</label>
            <input type="number" [(ngModel)]="reuniao.NoveMeses" min="0">
          </div>

          <div class="form-group">
            <label>1 Ano</label>
            <input type="number" [(ngModel)]="reuniao.UmAno" min="0">
          </div>

          <div class="form-group">
            <label>18 Meses</label>
            <input type="number" [(ngModel)]="reuniao.DezoitoMeses" min="0">
          </div>

          <div class="form-group">
            <label>Múltiplos Anos</label>
            <input type="number" [(ngModel)]="reuniao.MultiplosAnos" min="0">
          </div>
        </div>

        <!-- Seção de Despesas -->
        <div style="margin-top: 30px; border-top: 2px solid #ddd; padding-top: 20px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
            <h3 class="section-title" style="margin: 0;">Despesas</h3>
            <button type="button" class="btn btn-primary" (click)="openDespesaModal()" [disabled]="!reuniao.Id" style="flex-shrink: 0;">
              Adicionar Despesa
            </button>
          </div>
          
          <div *ngIf="!reuniao.Id" style="padding: 10px; background-color: #fff3cd; border-radius: 4px; margin-bottom: 15px;">
            <small>Salve a reunião primeiro para adicionar despesas</small>
          </div>

          <div class="table-container" *ngIf="reuniao.Id && despesas.length > 0" style="margin-top: 10px;">
          <table class="despesas-table" style="margin-top: 10px;">
            <thead>
              <tr>
                <th>Descrição</th>
                <th>Valor</th>
                <th>Comprovante</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let despesa of despesas">
                <td>{{ despesa.Descricao }}</td>
                <td>R$ {{ despesa.ValorDespesa }}</td>
                <td>
                  <span *ngIf="despesa.Comprovante">Sim</span>
                  <span *ngIf="!despesa.Comprovante">Não</span>
                </td>
                <td>
                  <button class="btn btn-success" (click)="openDespesaModal(despesa)">Editar</button>
                  <button class="btn btn-danger" (click)="deleteDespesa(despesa.Id)">Excluir</button>
                </td>
              </tr>
            </tbody>
          </table>
          </div>

          <div *ngIf="reuniao.Id && despesas.length === 0" style="text-align: center; padding: 20px; color: #666;">
            Nenhuma despesa cadastrada
          </div>
        </div>

        <div class="action-buttons" style="margin-top: 20px;">
          <button class="btn btn-primary" (click)="saveReuniao()">Salvar Reunião</button>
          <button class="btn btn-secondary" (click)="closeModal()">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Despesa -->
  <div class="modal" [class.show]="showDespesaModal">
    <div class="modal-content">
      <span class="close" (click)="closeDespesaModal()">&times;</span>
      <h2>{{ isEditDespesa ? 'Editar Despesa' : 'Nova Despesa' }}</h2>
      
      <div class="form-container">
        <div class="form-group">
          <label>Descrição *</label>
          <input type="text" [(ngModel)]="despesa.Descricao" placeholder="Descrição da despesa" required>
        </div>

        <div class="form-group">
          <label>Valor *</label>
          <input type="number" step="0.01" [(ngModel)]="despesa.ValorDespesa" min="0" placeholder="0.00" required>
        </div>

        <div class="form-group">
          <label>Comprovante</label>
          <input type="file" (change)="onFileSelected($event)" accept="image/*,application/pdf">
          <small style="display: block; margin-top: 5px; color: #666;">
            Formatos aceitos: Imagens (JPG, PNG) ou PDF
          </small>
        </div>

        <div class="action-buttons" style="margin-top: 20px;">
          <button class="btn btn-primary" (click)="saveDespesa()">Salvar</button>
          <button class="btn btn-secondary" (click)="closeDespesaModal()">Cancelar</button>
        </div>
      </div>
    </div>
  </div>
</div>
